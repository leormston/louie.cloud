name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '18.x'
  DEPLOYMENT_TIMEOUT: '600'

jobs:
  build:
    name: Build Application
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install frontend dependencies
        run: npm ci

      - name: Lint frontend
        run: npm run lint --if-present
        continue-on-error: true

      - name: Build React frontend
        env:
          VITE_COGNITO_REGION: ${{ secrets.VITE_COGNITO_REGION }}
          VITE_COGNITO_USER_POOL_ID: ${{ secrets.VITE_COGNITO_USER_POOL_ID }}
          VITE_COGNITO_CLIENT_ID: ${{ secrets.VITE_COGNITO_CLIENT_ID }}
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
        run: npm run build

      - name: Upload frontend artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: dist/
          retention-days: 1

      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci --production

      - name: Lint backend
        working-directory: ./backend
        run: npm run lint --if-present
        continue-on-error: true

      - name: Upload backend artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-dist
          path: backend/
          retention-days: 1

  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: build
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download frontend artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: dist/

      - name: Download backend artifacts
        uses: actions/download-artifact@v4
        with:
          name: backend-dist
          path: backend/

      - name: Configure SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Test SSH Connection
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          ssh -i ~/.ssh/deploy_key -o ConnectTimeout=10 ${EC2_USER}@${EC2_HOST} "echo 'SSH connection successful'"

      - name: Deploy frontend to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          rsync -avz --delete -e "ssh -i ~/.ssh/deploy_key" \
            dist/ ${EC2_USER}@${EC2_HOST}:/var/www/portfolio/frontend/ || exit 1

      - name: Deploy backend to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          rsync -avz --delete -e "ssh -i ~/.ssh/deploy_key" \
            --exclude 'node_modules' \
            --exclude '.env' \
            --exclude '.git' \
            backend/ ${EC2_USER}@${EC2_HOST}:/var/www/portfolio/backend/ || exit 1

      - name: Install backend dependencies on EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          ssh -i ~/.ssh/deploy_key ${EC2_USER}@${EC2_HOST} << 'EOF'
            cd /var/www/portfolio/backend
            npm ci --production 2>&1 | tail -20
            if [ ${PIPESTATUS[0]} -ne 0 ]; then
              echo "Failed to install backend dependencies"
              exit 1
            fi
          EOF

      - name: Restart backend service
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          ssh -i ~/.ssh/deploy_key ${EC2_USER}@${EC2_HOST} << 'EOF'
            # Check if PM2 is installed
            if ! command -v pm2 &> /dev/null; then
              echo "PM2 not found, installing..."
              sudo npm install -g pm2
            fi
            
            # Stop existing process
            pm2 stop portfolio-api || true
            pm2 delete portfolio-api || true
            
            # Start new process
            cd /var/www/portfolio/backend
            pm2 start server.js --name portfolio-api --env production
            pm2 save
            
            echo "PM2 process status:"
            pm2 status
          EOF

      - name: Health check
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          ssh -i ~/.ssh/deploy_key ${EC2_USER}@${EC2_HOST} << 'EOF'
            sleep 3
            echo "Checking backend health..."
            curl -f http://localhost:3000/health || echo "Health check endpoint not available"
            echo "Nginx status:"
            sudo systemctl status nginx
          EOF

      - name: Reload Nginx
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          ssh -i ~/.ssh/deploy_key ${EC2_USER}@${EC2_HOST} << 'EOF'
            sudo nginx -t && sudo systemctl reload nginx
            echo "Nginx reloaded successfully"
          EOF

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key

      - name: Deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Deployment successful!"
          else
            echo "❌ Deployment failed!"
            exit 1
          fi
